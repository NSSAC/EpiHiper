Bootstrap: docker
From: centos:7

%setup
    # SciDuct Interface
    [ -e ${SINGULARITY_ROOTFS}/input ] || mkdir -p $SINGULARITY_ROOTFS/input
    [ -e ${SINGULARITY_ROOTFS}/output ] || mkdir -p $SINGULARITY_ROOTFS/output
    [ -e ${SINGULARITY_ROOTFS}/job ] || mkdir -p $SINGULARITY_ROOTFS/job
    [ -e ${SINGULARITY_ROOTFS}/sciduct ] || mkdir -p $SINGULARITY_ROOTFS/sciduct
    [ -e ${SINGULARITY_ROOTFS}/epihiper/bin ] || mkdir -p $SINGULARITY_ROOTFS/epihiper/bin

    # Download packages required for the installation
    [ -e ${SINGULARITY_ROOTFS}/src ] || mkdir ${SINGULARITY_ROOTFS}/src

%files
    validation.json /sciduct/config.json
    bin/validateSchema.sh /epihiper/bin
    bin/validateRules.sh /epihiper/bin
    
%post
    # Ensure the the CentOS release is the same as on rivanna
    yum -y update
        
    # nodejs install
    curl -sL https://rpm.nodesource.com/setup_12.x | bash -
    yum install -y nodejs

    # jq is a processor for helping with json from bash
    npm install -g jq-cli-wrapper

    # Install the EpiHiper validator
    npm install -g @shoops/epi-hiper-validator
    ln -s /usr/lib/node_modules/@shoops/epi-hiper-validator/bin/epiHiper* /epihiper/bin


%apprun sciduct
    cat /sciduct/config.json

%apprun validateSchema
    echo Validating Schema
    echo Job ID: ${SLURM_JOB_ID:-222222}
    /epihiper/bin/validateSchema.sh $@

%apprun validateRules
    echo Validating Rules
    echo Job ID: ${SLURM_JOB_ID:-222222}
    /epihiper/bin/validateRules.sh $@
	
